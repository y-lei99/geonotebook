FROM registry.cn-beijing.aliyuncs.com/k8s_test/test:pangeo-v1

USER root

RUN apt-get update && \
    apt-get -y install gcc python3-dev python3-pip libxml2-dev libxslt1-dev zlib1g-dev g++ && \
    apt-get install -y --no-install-recommends ffmpeg && \
    rm -rf /var/lib/apt/lists/*
USER $NB_USER


RUN conda install --yes python=3.7
RUN conda install -c conda-forge gdal
RUN conda install --quiet --yes \
                       'curl' \
                       'pyproj' \
                       'pkg-config' \
                       'ipywidgets' \
                       'setuptools' \
                       'wheel' \
                       'pip' \
                       'cffi' \
                       'lxml' \
                       'numpy' \
                       'scipy' \
                       'pandas' \
                       'matplotlib' \
                       'seaborn' \
                       'cython' \
                       'statsmodels' \
                       'pyOpenSSL' \
                       'scikit-image' \
                       'dask-kubernetes' \
                       'flask' \
                       'sqlalchemy' \
                       'cx_Oracle' \
                       'nodejs' \
                       && \
                       conda clean --all -f -y && \
                       jupyter serverextension enable --py jupyterlab --sys-prefix && \
                       jupyter labextension install @jupyter-widgets/jupyterlab-manager && \
                       jupyter labextension install @jupyter-widgets/jupyterlab-manager jupyter-leaflet && \
                       jupyter nbextension enable --py widgetsnbextension --sys-prefix && \
                       #jupyter labextension install @jupyter-widgets/jupyterlab-manager@^1.0.1 --no-build && \
                       #jupyter labextension install jupyterlab_bokeh@1.0.0 --no-build && \
                       #jupyter lab build && \
                       npm cache clean --force && \
                       rm -rf $CONDA_DIR/share/jupyter/lab/staging && \
                       rm -rf /home/$NB_USER/.cache/yarn && \
                       rm -rf /home/$NB_USER/.node-gyp && \
                       fix-permissions $CONDA_DIR && \
                       fix-permissions /home/$NB_USER

WORKDIR $HOME

USER $NB_USER

